<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Quản Trị Hệ Thống - Quản Lý Bài Viết</title>
    <link rel="icon" href="/uploads/mini_logo.ico" type="image/png">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* Styling for thumbnails */
        .post-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }

        #previewModal .modal-content {
            background: linear-gradient(to bottom right, #ffffff, #f3f7fd);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        #previewModal .modal-header {
            background: linear-gradient(to right, #4e73df, #224abe);
            color: #fff;
            border-bottom: none;
        }

        #previewModal .post-preview-container h2 {
            color: #2e59d9;
            font-weight: 700;
            font-size: 1.8rem;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }

        #previewModal .post-meta {
            font-size: 0.95rem;
            font-style: italic;
            color: #6c757d;
        }

        #previewModal .post-content {
            font-size: 1rem;
            line-height: 1.75;
            margin-top: 20px;
            color: #333;
        }

        #previewModal .meta-description {
            font-size: 1.05rem;
            margin-top: 1rem;
            font-weight: 500;
            color: #5a5c69;
            background: #f8f9fc;
            padding: 12px 16px;
            border-left: 4px solid #4e73df;
            border-radius: 8px;
        }

        #previewModal .post-tags {
            margin-top: 20px;
        }

        #previewModal .post-tags .badge {
            font-size: 0.85rem;
            padding: 6px 12px;
            border-radius: 20px;
            background-color: #e2e6ea;
            color: #333;
        }

        #previewModal .modal-body {
            /* background-image: url('/uploads/banner_ads.png'); */
            background-color: #e6f3e0;
            background-size: cover;
            background-blend-mode: overlay;
        }



        /* Styling for tags */
        .tag-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            margin-right: 0.3rem;
            margin-bottom: 0.3rem;
            display: inline-block;
        }

        /* Preview image gallery */
        .preview-image-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .preview-image-item {
            width: 80px;
            height: 80px;
            border-radius: 4px;
            object-fit: cover;
            border: 1px solid #dee2e6;
        }

        /* Switch toggle customization */
        .switch-toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
            margin-bottom: 0;
        }

        .switch-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 22px;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.switch-slider {
            background-color: #28a745;
        }

        input:checked+.switch-slider:before {
            transform: translateX(20px);
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <%- include('partials/header') %>

                <!-- Main Content -->
                <div class="col-md-10 col-lg-10 ms-auto main-content">
                    <!-- Top Navbar -->
                    <nav class="top-navbar">
                        <h4 class="mb-0">Quản lý Bài viết</h4>
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <button class="notification-btn" type="button">
                                    <i class="fas fa-bell"></i>
                                    <span class="notification-badge">3</span>
                                </button>
                            </div>
                            <div class="dropdown">
                                <button class="user-dropdown border-0" type="button" id="userDropdown"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    <div class="user-avatar me-2">A</div>
                                    <span class="d-none d-md-inline">Admin</span>
                                    <i class="fas fa-chevron-down ms-2 small"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i> Hồ sơ</a>
                                    </li>
                                    <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i> Cài đặt</a>
                                    </li>
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li><a class="dropdown-item" href="#" onclick="logout()"><i
                                                class="fas fa-sign-out-alt me-2"></i> Đăng xuất</a></li>
                                </ul>
                            </div>
                        </div>
                    </nav>

                    <!-- Page Header -->
                    <div class="page-header">
                        <a href="/v1/api/admin/posts/create" class="btn btn-success">
                            <i class="fas fa-plus me-1"></i> Thêm bài viết mới
                        </a>
                    </div>

                    <!-- Search and Filter -->
                    <div class="row mb-4 align-items-end g-3">
                        <!-- Tìm kiếm -->
                        <div class="col-md-4">
                            <label for="searchTitle" class="form-label">Tìm kiếm bài viết</label>
                            <div class="input-group">
                                <input type="text" id="searchTitle" class="form-control" placeholder="Tiêu đề bài viết"
                                    value="<%= query?.search || '' %>">
                                <button class="btn btn-outline-primary" id="searchButton"><i
                                        class="fas fa-search"></i></button>
                            </div>
                        </div>

                        <!-- Trạng thái -->
                        <div class="col-md-2">
                            <label for="filterStatus" class="form-label">Trạng thái</label>
                            <select class="form-select" id="filterStatus">
                                <option value="" <%=!query?.status ? 'selected' : '' %>>Tất cả</option>
                                <option value="publish" <%=query?.status==='publish' ? 'selected' : '' %>>Đã đăng
                                </option>
                                <option value="draft" <%=query?.status==='draft' ? 'selected' : '' %>>Bản nháp</option>
                                <option value="canceled" <%=query?.status==='canceled' ? 'selected' : '' %>>Đã hủy
                                </option>
                            </select>
                        </div>

                        <!-- Danh mục -->
                        <div class="col-md-2">
                            <label for="filterCategory" class="form-label">Danh mục</label>
                            <select class="form-select" id="filterCategory">
                                <option value="">Tất cả</option>
                                <% for (const category of categories || []) { %>
                                    <option value="<%= category._id %>" <%=query?.category_id===category._id.toString()
                                        ? 'selected' : '' %>>
                                        <%= category.name %>
                                    </option>
                                    <% } %>
                            </select>
                        </div>

                        <!-- Sắp xếp -->
                        <div class="col-md-2">
                            <label for="sortOption" class="form-label">Sắp xếp</label>
                            <select class="form-select" id="sortOption">
                                <option value="">Mặc định</option>
                                <option value="createdAt_desc" <%=query?.sort==='createdAt_desc' ? 'selected' : '' %>
                                    >Mới nhất</option>
                                <option value="createdAt_asc" <%=query?.sort==='createdAt_asc' ? 'selected' : '' %>>Cũ
                                    nhất</option>
                                <option value="title_asc" <%=query?.sort==='title_asc' ? 'selected' : '' %>>Tiêu đề A-Z
                                </option>
                                <option value="title_desc" <%=query?.sort==='title_desc' ? 'selected' : '' %>>Tiêu đề
                                    Z-A</option>
                            </select>
                        </div>

                        <!-- Nút hành động -->
                        <div class="col-md-2 text-end">
                            <label class="form-label d-block invisible">Hành động</label>
                            <div class="btn-group w-100">
                                <button class="btn btn-outline-primary" id="applyFilter">
                                    <i class="fas fa-filter me-1"></i> Lọc
                                </button>
                                <button class="btn btn-outline-success" id="exportPostsButton">
                                    <i class="fas fa-download me-1"></i> Xuất
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Posts Table -->
                    <div class="card">
                        <div class="card-body p-0">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="ps-3" style="width: 70px;">Hình ảnh</th>
                                        <th>Tiêu đề</th>
                                        <th>Danh mục & Tags</th>
                                        <th>Ngày tạo</th>
                                        <th>Tác giả</th>
                                        <th>Trạng thái</th>
                                        <th class="text-end pe-3">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% posts.forEach(post=> { %>
                                        <tr>
                                            <td class="ps-3">
                                                <% if (post.thumbnail) { %>
                                                    <img src="<%= thumbnails[post._id] ? '/' + thumbnails[post._id].replace(/\\/g, '/').replace(/^\/?uploads/, 'uploads') : '/uploads/placeholder.jpg' %>"
                                                        alt="Hình ảnh bài viết" class="preview-image-item">

                                                    <% } else { %>
                                                        <div class="post-icon"
                                                            style="width: 40px; height: 40px; background-color: #f1f1f1; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                                            <i class="fas fa-file-alt text-secondary"></i>
                                                        </div>
                                                        <% } %>
                                            </td>
                                            <td>
                                                <div>
                                                    <strong>
                                                        <%= post.title %>
                                                    </strong>
                                                    <div class="text-muted small mt-1 text-truncate"
                                                        style="max-width: 250px;">
                                                        <%= post.meta_description || 'Không có mô tả' %>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <% if (post.category_id) { %>
                                                    <div class="mb-1">
                                                        <span class="badge bg-info">
                                                            <i class="fas fa-folder me-1"></i>
                                                            <%= categories.find(c=> c._id.toString() ===
                                                                post.category_id.toString())?.name || 'Không rõ' %>
                                                        </span>
                                                    </div>
                                                    <% } %>
                                                        <div>
                                                            <% (post.tags || []).slice(0, 3).forEach(tag=> { %>
                                                                <span class="badge bg-light text-dark tag-badge">
                                                                    <i class="fas fa-tag me-1 small"></i>
                                                                    <%= tag %>
                                                                </span>
                                                                <% }) %>
                                                                    <% if ((post.tags || []).length> 3) { %>
                                                                        <span class="badge bg-secondary tag-badge">+<%=
                                                                                post.tags.length - 3 %></span>
                                                                        <% } %>
                                                        </div>
                                            </td>
                                            <td>
                                                <%= new Date(post.createdAt).toLocaleDateString('vi-VN', {day: '2-digit'
                                                    , month: '2-digit' , year: 'numeric' }) %>
                                                    <div class="text-muted small">
                                                        <%= new Date(post.createdAt).toLocaleTimeString('vi-VN',
                                                            {hour: '2-digit' , minute: '2-digit' }) %>
                                                    </div>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="author-avatar me-2"
                                                        style="width: 32px; height: 32px; background-color: #e9ecef; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                        <i class="fas fa-user text-primary"></i>
                                                    </div>
                                                    <div>
                                                        <%= post.account_id?.full_name || post.account_id?.username ||
                                                            post.account_id?.email || 'Không rõ' %>
                                                    </div>
                                                </div>
                                            </td>

                                            <td>
                                                <% if (post.status==='publish' ) { %>
                                                    <span class="badge bg-success">Đã đăng</span>
                                                    <% } else if (post.status==='draft' ) { %>
                                                        <span class="badge bg-warning text-dark">Bản nháp</span>
                                                        <% } else if (post.status==='canceled' ) { %>
                                                            <span class="badge bg-secondary">Đã hủy</span>
                                                            <% } else { %>
                                                                <span class="badge bg-light text-dark">Không rõ</span>
                                                                <% } %>
                                            </td>
                                            <td class="text-end pe-3">
                                                <div class="action-buttons">
                                                    <button class="btn btn-sm btn-outline-info me-1" type="button"
                                                        data-bs-toggle="collapse"
                                                        data-bs-target="#details<%= post._id %>" aria-expanded="false">
                                                        <i class="fas fa-info-circle"></i>
                                                    </button>
                                                    <a href="/v1/api/admin/posts/edit/<%= post._id %>"
                                                        class="btn btn-sm btn-warning me-1">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <div class="form-check form-switch d-inline-block">
                                                        <label class="switch-toggle"
                                                            title="<%= post.status === 'draft' ? 'Bản nháp - click để đăng' : 'Đã đăng - click để chuyển nháp' %>">
                                                            <input type="checkbox" <%=post.status==='publish'
                                                                ? 'checked' : '' %> onchange="toggleStatus('<%= post._id
                                                                %>', '<%= post.status %>')">

                                                                    <span class="switch-slider"></span>
                                                        </label>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>

                                        <!-- Details Row -->
                                        <tr class="collapse" id="details<%= post._id %>">
                                            <td colspan="7" class="p-0">
                                                <div class="post-details p-3">
                                                    <div class="row g-4">
                                                        <!-- Post Preview Column -->
                                                        <div class="col-md-7">
                                                            <div class="post-preview">
                                                                <h6 class="mb-3"><i class="fas fa-eye me-2"></i>Xem
                                                                    trước nội dung</h6>
                                                                <div class="card border-0 shadow-sm">
                                                                    <div class="card-body p-3">
                                                                        <h5 class="card-title">
                                                                            <%= post.title %>
                                                                        </h5>
                                                                        <div class="card-text post-content-preview">
                                                                            <%- post.content.length> 300 ?
                                                                                post.content.substring(0, 300) + '...' :
                                                                                post.content %>
                                                                        </div>

                                                                        <% if (post.images && post.images.length> 0) {
                                                                            %>
                                                                            <div class="preview-image-gallery">
                                                                                <% post.images.slice(0,4).forEach(img=>
                                                                                    { %>
                                                                                    <img src="<%= img.url || ('/' + img.file_path.replace(/\\/g, '/')) %>"
                                                                                        class="preview-image-item"
                                                                                        alt="ảnh" />



                                                                                    <% }) %>

                                                                                        <% if (post.images.length>
                                                                                            4) {
                                                                                            %>
                                                                                            <div
                                                                                                class="preview-image-item d-flex align-items-center justify-content-center bg-light">
                                                                                                +<%= post.images.length
                                                                                                    - 4 %>
                                                                                            </div>
                                                                                            <% } %>
                                                                            </div>
                                                                            <% } %>

                                                                                <div class="text-end mt-3">
                                                                                    <button
                                                                                        class="btn btn-sm btn-primary"
                                                                                        onclick="previewPost('<%= post._id %>')">
                                                                                        <i
                                                                                            class="fas fa-external-link-alt me-1"></i>
                                                                                        Xem đầy đủ
                                                                                    </button>
                                                                                </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Post Metadata Column -->
                                                        <div class="col-md-5">
                                                            <div class="post-metadata">
                                                                <h6 class="mb-3"><i
                                                                        class="fas fa-info-circle me-2"></i>Thông tin
                                                                    bài viết</h6>
                                                                <div class="card border-0 shadow-sm">
                                                                    <div class="card-body p-3">
                                                                        <ul class="list-group list-group-flush">
                                                                            <li
                                                                                class="list-group-item px-0 py-2 border-bottom">
                                                                                <i
                                                                                    class="fas fa-link text-primary me-2"></i>
                                                                                <strong>Slug:</strong>
                                                                                <span class="text-monospace">
                                                                                    <%= post.slug %>
                                                                                </span>
                                                                            </li>
                                                                            <li
                                                                                class="list-group-item px-0 py-2 border-bottom">
                                                                                <i
                                                                                    class="fas fa-folder text-primary me-2"></i>
                                                                                <strong>Danh mục:</strong>
                                                                                <% if (post.category_id) { %>
                                                                                    <%= categories.find(c=>
                                                                                        c._id.toString() ===
                                                                                        post.category_id.toString())?.name
                                                                                        || 'Không có' %>
                                                                                        <% } else { %>
                                                                                            Không có
                                                                                            <% } %>
                                                                            </li>
                                                                            <li
                                                                                class="list-group-item px-0 py-2 border-bottom">
                                                                                <i
                                                                                    class="fas fa-tags text-primary me-2"></i>
                                                                                <strong>Tags:</strong>
                                                                                <div class="mt-1">
                                                                                    <% if (post.tags &&
                                                                                        post.tags.length> 0) { %>
                                                                                        <% post.tags.forEach(tag=> { %>
                                                                                            <span
                                                                                                class="badge bg-light text-dark tag-badge">
                                                                                                <%= tag %>
                                                                                            </span>
                                                                                            <% }) %>
                                                                                                <% } else { %>
                                                                                                    <span
                                                                                                        class="text-muted">Không
                                                                                                        có tag</span>
                                                                                                    <% } %>
                                                                                </div>
                                                                            </li>
                                                                            <li
                                                                                class="list-group-item px-0 py-2 border-bottom">
                                                                                <i
                                                                                    class="fas fa-shopping-cart text-primary me-2"></i>
                                                                                <strong>Sản phẩm liên quan:</strong>
                                                                                <div class="mt-1">
                                                                                    <% if (post.related_products &&
                                                                                        post.related_products.length> 0)
                                                                                        { %>
                                                                                        <% post.related_products.forEach((productId,
                                                                                            index)=> { %>
                                                                                            <span
                                                                                                class="badge bg-light text-dark">
                                                                                                <%= productId.product_name
                                                                                                    || `Sản phẩm
                                                                                                    #${index + 1}` %>
                                                                                            </span>
                                                                                            <% }) %>
                                                                                                <% } else { %>
                                                                                                    <span
                                                                                                        class="text-muted">Không
                                                                                                        có sản phẩm liên
                                                                                                        quan</span>
                                                                                                    <% } %>
                                                                                </div>


                                                                            </li>


                                                                            <li
                                                                                class="list-group-item px-0 py-2 border-bottom">
                                                                                <i
                                                                                    class="fas fa-user-edit text-primary me-2"></i>
                                                                                <strong>Tác giả:</strong>
                                                                                <% if
                                                                                    (post.account_id?.profile_image?.url)
                                                                                    { %>
                                                                                    <img src="<%= post.account_id.profile_image.url %>"
                                                                                        alt="Avatar"
                                                                                        class="rounded-circle me-2"
                                                                                        width="32" height="32">
                                                                                    <% } %>
                                                                                        <%= post.account_id?.full_name
                                                                                            || post.account_id?.username
                                                                                            || post.account_id?.email
                                                                                            || 'Không rõ' %>

                                                                            </li>


                                                                            <li
                                                                                class="list-group-item px-0 py-2 border-bottom">
                                                                                <i
                                                                                    class="fas fa-calendar-alt text-primary me-2"></i>
                                                                                <strong>Ngày tạo:</strong>
                                                                                <%= new
                                                                                    Date(post.createdAt).toLocaleDateString('vi-VN',
                                                                                    {day: '2-digit' , month: '2-digit' ,
                                                                                    year: 'numeric' , hour: '2-digit' ,
                                                                                    minute: '2-digit' }) %>
                                                                            </li>
                                                                            <li class="list-group-item px-0 py-2">
                                                                                <i
                                                                                    class="fas fa-edit text-primary me-2"></i>
                                                                                <strong>Cập nhật:</strong>
                                                                                <%= new
                                                                                    Date(post.updatedAt).toLocaleDateString('vi-VN',
                                                                                    {day: '2-digit' , month: '2-digit' ,
                                                                                    year: 'numeric' , hour: '2-digit' ,
                                                                                    minute: '2-digit' }) %>
                                                                            </li>
                                                                        </ul>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        <% }); %>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Success Modal -->
                    <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content border-success">
                                <div class="modal-header bg-success text-white">
                                    <h5 class="modal-title" id="statusModalLabel"><i
                                            class="fas fa-check-circle me-2"></i>Thành công</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                        aria-label="Đóng"></button>
                                </div>
                                <div class="modal-body" id="statusModalBody">
                                    Trạng thái bài viết đã được cập nhật.
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-success" data-bs-dismiss="modal"
                                        onclick="location.reload()">
                                        Tải lại trang
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Confirm Modal -->
                    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content border-warning">
                                <div class="modal-header bg-warning text-dark">
                                    <h5 class="modal-title" id="confirmModalLabel"><i
                                            class="fas fa-exclamation-circle me-2"></i>Xác nhận thay đổi</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Đóng"></button>
                                </div>
                                <div class="modal-body" id="confirmModalBody">
                                    Bạn có chắc chắn muốn thay đổi trạng thái bài viết này?
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                    <button type="button" class="btn btn-warning" id="confirmBtn">Xác nhận</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Preview -->
                    <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
                            <div class="modal-content border-0 shadow-lg">
                                <div class="modal-header bg-primary text-white py-3">
                                    <h5 class="modal-title" id="previewModalLabel">
                                        <i class="fas fa-eye me-2"></i>Xem trước bài viết
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                        aria-label="Đóng"></button>
                                </div>
                                <div class="modal-body p-0">
                                    <!-- Loading indicator -->
                                    <div id="previewLoader" class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Đang tải...</span>
                                        </div>
                                        <p class="text-muted mt-3">Đang tải nội dung bài viết...</p>
                                    </div>

                                    <!-- Actual content container -->
                                    <div id="previewContent" class="p-4">
                                        <!-- Nội dung bài viết sẽ được chèn vào đây -->
                                    </div>
                                </div>
                                <div class="modal-footer bg-light py-3">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="fas fa-times me-1"></i>Đóng
                                    </button>
                                    <button type="button" class="btn btn-primary" id="printPreviewBtn">
                                        <i class="fas fa-print me-1"></i>In bài viết
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <nav>
                        <ul class="pagination justify-content-center mt-4">
                            <% for (let i=1; i <=totalPages; i++) { %>
                                <li class="page-item <%= i === currentPage ? ' active' : '' %>">
                                    <a class="page-link"
                                        href="/v1/api/admin/posts/list?<%= new URLSearchParams({ ...query, page: i }).toString() %>">
                                        <%= i %>
                                    </a>
                                </li>
                                <% } %>
                        </ul>
                    </nav>
                </div>
        </div>
    </div>

    <!-- Bootstrap and other scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.querySelectorAll('.nav-link').forEach(item => {
            item.addEventListener('click', function () {
                // Xóa lớp active khỏi tất cả các liên kết
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                // Thêm lớp active vào mục được chọn
                this.classList.add('active');
            });
        });

        document.getElementById('exportPostsButton').addEventListener('click', function () {
            fetch('/v1/api/admin/posts/export', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    }
                    throw new Error('Error exporting posts')
                })
                .then(blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);  // Tạo URL cho file Blob
                    link.download = 'all_posts.xlsx';  // Đặt tên file khi tải về
                    link.click();  // Tự động click vào link để tải file
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi khi xuất file.');
                })
        });

        let pendingPostId = null;
        let pendingNewStatus = null;

        async function toggleStatus(postId, currentStatus) {
            const newStatus = currentStatus === 'publish' ? 'draft' : 'publish'; // Toggle the status

            const confirmText = currentStatus === 'publish'
                ? "Bạn muốn chuyển bài viết này sang trạng thái BẢN NHÁP?"
                : "Bạn muốn ĐĂNG bài viết này?";

            // Set the confirmation text in the modal body
            document.getElementById("confirmModalBody").textContent = confirmText;

            // Show the confirmation modal
            const confirmModal = new bootstrap.Modal(document.getElementById("confirmModal"));
            confirmModal.show();

            // Wait for confirmation before proceeding
            document.getElementById("confirmBtn").onclick = async function () {
                // Close the confirmation modal after confirming
                const confirmModalInstance = bootstrap.Modal.getInstance(document.getElementById("confirmModal"));
                confirmModalInstance.hide();

                console.log("Confirmed toggle status for post ID:", postId, "to", newStatus);

                try {
                    // Make the PUT request to change the post status
                    const response = await fetch(`/v1/api/admin/posts/${postId}/toggle-status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            newStatus: newStatus
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Show a success modal
                        const statusModal = new bootstrap.Modal(document.getElementById("statusModal"));
                        document.getElementById("statusModalBody").textContent = data.message || "Trạng thái bài viết đã được cập nhật thành công.";
                        statusModal.show();

                        // Delay the page reload to ensure the success modal is visible
                        setTimeout(function () {
                            location.reload(); // Reload the page after successful update
                        }, 1500); // 1.5 seconds delay before reloading
                    } else {
                        alert(data.message || "Có lỗi xảy ra khi cập nhật trạng thái.");
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("Có lỗi xảy ra khi cập nhật trạng thái bài viết.");
                }
            };
        }


        // Handle search and filter
        document.getElementById('applyFilter').addEventListener('click', function () {
            applyFilters();
        });

        document.getElementById('searchTitle').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });

        document.getElementById('searchButton').addEventListener('click', function () {
            applyFilters();
        });

        function applyFilters() {
            const searchValue = document.getElementById('searchTitle').value;
            const statusValue = document.getElementById('filterStatus').value;
            const categoryValue = document.getElementById('filterCategory').value;
            const sortValue = document.getElementById('sortOption').value;

            let url = '/v1/api/admin/posts/list?';
            const params = new URLSearchParams();

            if (searchValue) params.append('search', searchValue);
            if (statusValue) params.append('status', statusValue);
            if (categoryValue) params.append('category_id', categoryValue);
            if (sortValue) params.append('sort', sortValue);

            window.location.href = url + params.toString();
        }

        // Preview post function
        async function previewPost(postId) {
            const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
            previewModal.show();

            const loader = document.getElementById('previewLoader');
            const content = document.getElementById('previewContent');
            loader.style.display = 'block';
            content.style.display = 'none';

            try {
                const response = await fetch(`/v1/api/admin/posts/${postId}/preview`);
                if (!response.ok) throw new Error('Failed to load post preview');

                const data = await response.json();
                console.log('Preview data:', data);

                // Gộp thumbnail và gallery
                const galleryImages = [
                    ...(data.thumbnail ? [{ url: data.thumbnail }] : []),
                    ...(Array.isArray(data.gallery) ? data.gallery : [])
                ];

                const galleryHTML = (galleryImages.length > 0) ? `
            <div id="postGalleryCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
                <div class="carousel-inner">
                    ${galleryImages.map((img, index) => `
                        <div class="carousel-item ${index === 0 ? 'active' : ''}">
                            <img src="${img.url || ('/' + img.file_path)}" class="d-block mx-auto rounded shadow-sm"
                                style="max-height: 280px; width: auto; object-fit: cover;" alt="Ảnh ${index + 1}">
                        </div>
                    `).join('')}
                </div>
                ${galleryImages.length > 1 ? `
                <button class="carousel-control-prev" type="button" data-bs-target="#postGalleryCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Trước</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#postGalleryCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Sau</span>
                </button>` : ''}
            </div>
        ` : '';

                const previewHTML = `
            <div class="post-preview-container">
                <h2 class="mb-3 text-primary">${data.title}</h2>

                <div class="post-meta mb-4 text-muted">
                    <span class="me-3"><i class="fas fa-user me-1"></i>${data.author || 'Không rõ'}</span>
                    <span class="me-3"><i class="fas fa-calendar me-1"></i>${new Date(data.createdAt).toLocaleDateString('vi-VN')}</span>
                    ${data.category ? `<span class="me-3"><i class="fas fa-folder me-1"></i>${data.category}</span>` : ''}
                </div>

                ${galleryHTML}

                <div class="post-content mb-3">
                    ${data.content}
                </div>

                <div class="meta-description mb-3 text-muted fst-italic">
                    ${data.meta_description || ''}
                </div>

                ${data.tags && data.tags.length > 0 ? `
                    <div class="post-tags mt-4">
                        <strong class="text-secondary"><i class="fas fa-tags me-1"></i>Tags:</strong>
                        <div class="mt-2">
                            ${data.tags.map(tag => `<span class="badge bg-light text-dark me-1">${tag}</span>`).join('')}
                        </div>
                    </div>` : ''}
            </div>
        `;

                content.innerHTML = previewHTML;
                loader.style.display = 'none';
                content.style.display = 'block';

                document.getElementById('previewModalLabel').textContent = `Xem trước: ${data.title}`;
            } catch (error) {
                console.error('Error:', error);
                content.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                Không thể tải nội dung bài viết. Vui lòng thử lại sau.
            </div>
        `;
                loader.style.display = 'none';
                content.style.display = 'block';
            }
        }



        // Print preview function
        document.getElementById('printPreviewBtn').addEventListener('click', function () {
            const printWindow = window.open('', '_blank');
            const content = document.getElementById('previewContent').innerHTML;
            const title = document.getElementById('previewModalLabel').textContent.replace('Xem trước: ', '');

            const html = `
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>${title}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        img { max-width: 100%; height: auto; }
        @media print {
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <div class="no-print text-end mb-3">
            <button class="btn btn-primary" onclick="window.print()">
                <i class="fas fa-print me-1"></i>In
            </button>
            <button class="btn btn-secondary ms-2" onclick="window.close()">
                <i class="fas fa-times me-1"></i>Đóng
            </button>
        </div>
        ${content}
    </div>
</body>
</html>
    `;

            printWindow.document.open();
            printWindow.document.write(html);
            printWindow.document.close();
        });


        // Logout function
        function logout() {
            fetch('/v1/api/admin/auth/logout', {
                method: 'POST',
                credentials: 'same-origin'
            })
                .then(response => {
                    if (response.ok) {
                        window.location.href = '/v1/api/admin/auth/login';
                    } else {
                        throw new Error('Logout failed');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Đã xảy ra lỗi khi đăng xuất.');
                });
        }
    </script>
</body>

</html>