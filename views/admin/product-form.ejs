<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Quản Trị Hệ Thống - <%= action %> Sản Phẩm</title>
    <link rel="icon" href="/uploads/mini_logo.ico" type="image/png">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #f8f9fc;
            --accent-color: #5a5c69;
            --success-color: #1cc88a;
            --danger-color: #e74a3b;
        }

        body {
            background-color: #f8f9fc;
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        .card {
            border: none;
            border-radius: 0.35rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            margin-bottom: 1.5rem;
        }

        .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid #e3e6f0;
            padding: 1rem 1.35rem;
            font-weight: 700;
            color: #4e73df;
        }

        .form-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e3e6f0;
        }

        .form-section:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .form-section-title {
            font-weight: 700;
            margin-bottom: 1rem;
            color: #5a5c69;
        }

        .btn-add-field {
            margin-top: 0.75rem;
            font-size: 0.85rem;
        }

        .sticky-sidebar {
            position: sticky;
            top: 100px;
            /* khoảng cách cách đỉnh khi dính */
            z-index: 2;
            /* cao hơn nội dung khác */
        }

        .remove-attribute,
        .remove-variation {
            background-color: #e74a3b;
            color: white;
            border: none;
        }

        .remove-attribute:hover,
        .remove-variation:hover {
            background-color: #c0392b;
        }

        .main-content {
            padding: 2rem;
        }

        label {
            font-weight: 600;
            color: #5a5c69;
        }

        .form-control:focus {
            border-color: #bac8f3;
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        }

        .attribute-row,
        .variation-row {
            background-color: #f8f9fc;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            border-radius: 0.35rem;
            border: 1px solid #e3e6f0;
        }

        .btn-primary {
            background-color: #4e73df;
            border-color: #4e73df;
        }

        .btn-primary:hover {
            background-color: #2e59d9;
            border-color: #2653d4;
        }

        .thumbnail-preview {
            width: 150px;
            /* Giữ kích thước cố định để hiển thị đều */
            height: 150px;
            /* Đảm bảo ảnh có tỷ lệ vuông */
            object-fit: cover;
            /* Giữ ảnh đầy đủ khung, cắt bớt phần dư */
            border: 2px solid #d1d3e2;
            /* Viền nhẹ màu xám */
            background-color: #f8f9fc;
            /* Màu nền dịu nhẹ, giống giao diện admin */
            display: none;
            /* Ẩn mặc định, chỉ hiển thị khi có ảnh */
            margin-top: 0.5rem;
            border-radius: 8px;
            /* Bo góc nhẹ */
            box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.1);
            /* Đổ bóng nhẹ tạo cảm giác nổi bật */
            transition: all 0.3s ease-in-out;
            /* Hiệu ứng mượt mà khi thay đổi */
        }

        .thumbnail-preview.show {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        .custom-file-input:focus~.custom-file-label {
            border-color: #bac8f3;
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        }

        /* Custom styling for select boxes */
        .form-select:focus {
            border-color: #bac8f3;
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        }

        /* Badge styling */
        .badge {
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-required {
            background-color: #e74a3b;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Main Content -->
            <div class="col-md-10 col-lg-10 mx-auto main-content">
                <div class="d-sm-flex align-items-center justify-content-between mb-4">
                    <h1 class="h3 mb-0 text-gray-800">
                        <%= action %> Sản Phẩm
                    </h1>
                    <a href="/v1/api/admin/products/list"
                        class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm">
                        <i class="fas fa-arrow-left fa-sm text-white-50 me-1"></i> Quay lại danh sách
                    </a>
                </div>

                <form action="/v1/api/shop/products/<%= action === 'Edit' ? product._id : '' %>"
                    method="<%= action === 'Edit' ? 'PUT' : 'POST' %>" enctype="multipart/form-data" id="productForm">
                    <div class="row">
                        <div class="col-lg-8">
                            <!-- Thông tin cơ bản -->
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-info-circle me-2"></i> Thông tin cơ bản
                                </div>
                                <div class="card-body">
                                    <div class="form-section">
                                        <div class="mb-3">
                                            <label for="product_name" class="form-label">Tên sản phẩm <span
                                                    class="badge bg-danger badge-required">Bắt buộc</span></label>
                                            <input type="text" class="form-control" id="product_name"
                                                name="product_name" value="<%= product ? product.product_name : '' %>"
                                                placeholder="Nhập tên sản phẩm" required>
                                        </div>

                                        <div class="mb-3">
                                            <label for="category" class="form-label">Danh mục <span
                                                    class="badge bg-danger badge-required">Bắt buộc</span></label>
                                            <select class="form-select" id="category" name="category" required>
                                                <option value="" disabled selected>Chọn danh mục</option>
                                                <% if (categories && categories.length> 0) { %>
                                                    <% categories.forEach(category=> { %>
                                                        <option value="<%= category._id %>" <%=product &&
                                                            product.category &&
                                                            product.category._id.toString()===category._id.toString()
                                                            ? 'selected' : '' %>><%= category.name %>
                                                        </option>
                                                        <% }); %>
                                                            <% } else { %>
                                                                <option value="" disabled>Không có danh mục nào</option>
                                                                <% } %>
                                            </select>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="product_price" class="form-label">Giá (VNĐ) <span
                                                            class="badge bg-danger badge-required">Bắt
                                                            buộc</span></label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="product_price"
                                                            name="product_price"
                                                            value="<%= product ? product.product_price : '' %>"
                                                            placeholder="Nhập giá sản phẩm" required>
                                                        <span class="input-group-text">₫</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="product_stock" class="form-label">Số lượng trong kho
                                                        <span class="badge bg-danger badge-required">Bắt
                                                            buộc</span></label>
                                                    <input type="number" class="form-control" id="product_stock"
                                                        name="product_stock"
                                                        value="<%= product ? product.product_stock : '' %>"
                                                        placeholder="Nhập số lượng" required>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="product_description" class="form-label">Mô tả sản phẩm</label>
                                            <textarea class="form-control" id="product_description"
                                                name="product_description" rows="4"
                                                placeholder="Nhập mô tả chi tiết về sản phẩm"><%= product && product.product_description ? product.product_description : '' %></textarea>
                                        </div>
                                    </div>

                                    <!-- Thuộc tính sản phẩm -->
                                    <div class="form-section">
                                        <div
                                            class="form-section-title d-flex justify-content-between align-items-center">
                                            <div><i class="fas fa-list-ul me-2"></i> Thuộc tính sản phẩm</div>
                                            <button type="button" class="btn btn-outline-primary btn-sm"
                                                id="add-attribute">
                                                <i class="fas fa-plus me-1"></i> Thêm thuộc tính
                                            </button>
                                        </div>
                                        <div id="attributes-container">
                                            <% if (product && product.product_attributes) { %>
                                                <% Object.keys(product.product_attributes).forEach((key, index)=> { %>
                                                    <div class="attribute-row">
                                                        <div class="row">
                                                            <div class="col-md-5">
                                                                <div class="mb-2">
                                                                    <label class="form-label">Tên thuộc tính</label>
                                                                    <input type="text" class="form-control"
                                                                        name="attribute_keys[]" value="<%= key %>"
                                                                        placeholder="VD: Màu sắc, Kích thước...">
                                                                </div>
                                                            </div>
                                                            <div class="col-md-5">
                                                                <div class="mb-2">
                                                                    <label class="form-label">Giá trị</label>
                                                                    <input type="text" class="form-control"
                                                                        name="attribute_values[]"
                                                                        value="<%= product.product_attributes[key] %>"
                                                                        placeholder="VD: Đỏ, XL...">
                                                                </div>
                                                            </div>
                                                            <div class="col-md-2 d-flex align-items-end">
                                                                <button type="button"
                                                                    class="btn btn-sm remove-attribute">
                                                                    <i class="fas fa-times"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <% }); %>
                                                        <% } else { %>
                                                            <div class="attribute-row">
                                                                <div class="row">
                                                                    <div class="col-md-5">
                                                                        <div class="mb-2">
                                                                            <label class="form-label">Tên thuộc
                                                                                tính</label>
                                                                            <input type="text" class="form-control"
                                                                                name="attribute_keys[]"
                                                                                placeholder="VD: Màu sắc, Kích thước...">
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-5">
                                                                        <div class="mb-2">
                                                                            <label class="form-label">Giá trị</label>
                                                                            <input type="text" class="form-control"
                                                                                name="attribute_values[]"
                                                                                placeholder="VD: Đỏ, XL...">
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-2 d-flex align-items-end">
                                                                        <button type="button"
                                                                            class="btn btn-sm remove-attribute">
                                                                            <i class="fas fa-times"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <% } %>
                                        </div>
                                    </div>

                                    <!-- Biến thể sản phẩm -->
                                    <div class="form-section">
                                        <div
                                            class="form-section-title d-flex justify-content-between align-items-center">
                                            <div><i class="fas fa-random me-2"></i> Biến thể sản phẩm</div>
                                            <button type="button" class="btn btn-outline-primary btn-sm"
                                                id="add-variation">
                                                <i class="fas fa-plus me-1"></i> Thêm biến thể
                                            </button>
                                        </div>
                                        <div id="variations-container">
                                            <% if (product && product.variations && product.variations.length> 0) { %>
                                                <% product.variations.forEach((variation, index)=> { %>
                                                    <div class="variation-row">
                                                        <div class="row">
                                                            <div class="col-md-3">
                                                                <div class="mb-2">
                                                                    <label class="form-label">Tên biến thể</label>
                                                                    <input type="text" class="form-control"
                                                                        name="variant_names[]"
                                                                        value="<%= variation.variant_name %>"
                                                                        placeholder="VD: Màu, Size...">
                                                                </div>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <div class="mb-2">
                                                                    <label class="form-label">Giá trị</label>
                                                                    <input type="text" class="form-control"
                                                                        name="variant_values[]"
                                                                        value="<%= variation.variant_value %>"
                                                                        placeholder="VD: Đỏ, M...">
                                                                </div>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <div class="mb-2">
                                                                    <label class="form-label">Giá (VNĐ)</label>
                                                                    <div class="input-group">
                                                                        <input type="number" class="form-control"
                                                                            name="variant_prices[]"
                                                                            value="<%= variation.price %>"
                                                                            placeholder="Giá biến thể">
                                                                        <span class="input-group-text">₫</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-2">
                                                                <div class="mb-2">
                                                                    <label class="form-label">Kho</label>
                                                                    <input type="number" class="form-control"
                                                                        name="variant_stocks[]"
                                                                        value="<%= variation.stock %>"
                                                                        placeholder="Số lượng">
                                                                </div>
                                                            </div>
                                                            <div class="col-md-1 d-flex align-items-end">
                                                                <button type="button"
                                                                    class="btn btn-sm remove-variation">
                                                                    <i class="fas fa-times"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <% }); %>
                                                        <% } else { %>
                                                            <div class="variation-row">
                                                                <div class="row">
                                                                    <div class="col-md-3">
                                                                        <div class="mb-2">
                                                                            <label class="form-label">Tên biến
                                                                                thể</label>
                                                                            <input type="text" class="form-control"
                                                                                name="variant_names[]"
                                                                                placeholder="VD: Màu, Size...">
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-3">
                                                                        <div class="mb-2">
                                                                            <label class="form-label">Giá trị</label>
                                                                            <input type="text" class="form-control"
                                                                                name="variant_values[]"
                                                                                placeholder="VD: Đỏ, M...">
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-3">
                                                                        <div class="mb-2">
                                                                            <label class="form-label">Giá (VNĐ)</label>
                                                                            <div class="input-group">
                                                                                <input type="number"
                                                                                    class="form-control"
                                                                                    name="variant_prices[]"
                                                                                    placeholder="Giá biến thể">
                                                                                <span class="input-group-text">₫</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-2">
                                                                        <div class="mb-2">
                                                                            <label class="form-label">Kho</label>
                                                                            <input type="number" class="form-control"
                                                                                name="variant_stocks[]"
                                                                                placeholder="Số lượng">
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-1 d-flex align-items-end">
                                                                        <button type="button"
                                                                            class="btn btn-sm remove-variation">
                                                                            <i class="fas fa-times"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="sticky-sidebar">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-image me-2"></i> Ảnh đại diện
                                    </div>
                                    <div class="card-body text-center">
                                        <div class="mb-3">
                                            <div class="d-flex flex-column align-items-center">
                                                <img id="thumbnail-preview"
                                                    src="<%= product && product.product_thumbnail ? '/' + product.product_thumbnail : 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSzSncjhoWGdsxRm0LnCc5FD9kj86QoiTVAhw&s' %>"
                                                    class="img-fluid thumbnail-preview <%= product && product.product_thumbnail ? 'show' : '' %>"
                                                    alt="Ảnh đại diện">


                                                <div class="mt-3 text-center">
                                                    <label for="product_thumbnail" class="btn btn-outline-primary">
                                                        <i class="fas fa-upload me-2"></i> Chọn ảnh
                                                    </label>
                                                    <input type="file" id="product_thumbnail" name="product_thumbnail"
                                                        accept="image/*" class="d-none">
                                                </div>
                                                <small class="form-text text-muted mt-2">Định dạng: JPG, PNG, GIF.
                                                    Kích thước tối đa: 2MB</small>
                                                <% if (product && product.product_thumbnail) { %>
                                                    <button type="button" id="remove-thumbnail"
                                                        class="btn btn-outline-danger btn-sm mt-2">
                                                        <i class="fas fa-trash me-1"></i> Xóa ảnh
                                                    </button>
                                                    <% } %>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Trạng thái và hành động -->
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-cog me-2"></i> Trạng thái & Hành động
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="status" class="form-label">Trạng thái sản phẩm</label>
                                            <select class="form-select" id="status" name="status">
                                                <option value="active" <%=product && product.status==='active'
                                                    ? 'selected' : '' %>>Hiển thị</option>
                                                <option value="inactive" <%=product && product.status==='inactive'
                                                    ? 'selected' : '' %>>Ẩn</option>
                                                <option value="draft" <%=product && product.status==='draft'
                                                    ? 'selected' : '' %>>Bản nháp</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="featured" class="form-label">Sản phẩm nổi bật</label>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="featured"
                                                    name="featured" <%=product && product.featured ? 'checked' : '' %>>
                                                <label class="form-check-label" for="featured">Đánh dấu là sản phẩm nổi
                                                    bật</label>
                                            </div>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save me-1"></i> Lưu sản phẩm
                                            </button>
                                            <a href="/v1/api/admin/products/list" class="btn btn-outline-secondary">
                                                <i class="fas fa-times me-1"></i> Hủy
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Ảnh đại diện sản phẩm -->

                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap and other scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('productForm');
            const isEdit = form.getAttribute('action').includes('/products/') && form.getAttribute('method') === 'PUT';
            const isCheck = form.getAttribute('action');
            console.log('isEdit:', isEdit);



            form.addEventListener('submit', function (event) {
                event.preventDefault();

                // Lấy dữ liệu từ form
                const formData = new FormData(form);

                const apiUrl = form.getAttribute('action');
                const accessToken = localStorage.getItem('accessToken');
                const userId = localStorage.getItem('userId');
                const apiKey = 'c244dcd1532c91ab98a1c028e4f24f81457cdb2ac83e2ca422d36046fec84233589a4b51eda05e24d8871f73653708e3b13cf6dd1415a6330eaf6707217ef683'
                console.log("API URL:", apiUrl);


                console.log("Form đang gửi đi với các trường:");
                for (let pair of formData.entries()) {
                    console.log(pair[0] + ': ' + pair[1]);
                }

                // URL API endpoint: Đảm bảo rằng URL endpoint đúng cho việc create hoặc update
                // let apiUrl = '/v1/api/shop/products'; // Đảm bảo đây là đúng endpoint của bạn
                // if (isEdit) {
                //     // Nếu là chỉnh sửa sản phẩm, thêm ID sản phẩm vào URL
                //     const productId = form.getAttribute('data-product-id');  // Lấy ID sản phẩm từ data attribute
                //     apiUrl = `/v1/api/shop/products/${productId}`;  // Cập nhật sản phẩm
                // }

                // Gửi yêu cầu POST hoặc PUT đến API tạo hoặc cập nhật sản phẩm
                fetch(apiUrl, {
                    method: isEdit ? 'PUT' : 'POST',  // Chọn POST cho create, PUT cho update
                    body: formData,  // Gửi dữ liệu form (bao gồm ảnh và các trường khác)
                    headers: {
                        authorization: accessToken,
                        'x-client-id': userId,
                        'x-api-key': apiKey
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok: ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success === true) {
                            console.log("Success:", data);

                            alert('Sản phẩm đã được ' + (isEdit ? 'cập nhật' : 'thêm') + ' thành công!');
                            window.location.href = '/v1/api/admin/products/list'; // Điều hướng đến danh sách sản phẩm
                        } else {
                            console.log("Error:", data.success);
                            alert('Có lỗi xảy ra: ' + (data.message || 'Vui lòng thử lại!'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Có lỗi xảy ra khi gửi dữ liệu: ' + error.message);
                    });
            });
            // Hiển thị preview ảnh đại diện
            const thumbnailInput = document.getElementById('product_thumbnail');
            const thumbnailPreview = document.getElementById('thumbnail-preview');

            thumbnailInput.addEventListener('change', function () {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();

                    reader.onload = function (e) {
                        thumbnailPreview.src = e.target.result;
                        thumbnailPreview.classList.add('show'); // ✅ hiện lại ảnh
                    };

                    reader.readAsDataURL(this.files[0]);

                    // Nếu bị ẩn bởi lần xoá trước thì remove class hidden
                    thumbnailPreview.classList.add('show');

                    // Nếu có input hidden báo xoá ảnh, thì xoá đi vì giờ user đã chọn lại ảnh
                    const removeInput = document.querySelector('input[name="remove_thumbnail"]');
                    if (removeInput) {
                        removeInput.remove();
                    }

                    // Nếu nút "Xóa ảnh" chưa tồn tại, thì thêm lại
                    if (!document.getElementById('remove-thumbnail')) {
                        const removeButton = document.createElement('button');
                        removeButton.id = 'remove-thumbnail';
                        removeButton.className = 'btn btn-outline-danger btn-sm mt-2';
                        removeButton.innerHTML = '<i class="fas fa-trash me-1"></i> Xóa ảnh';
                        thumbnailInput.parentNode.parentNode.appendChild(removeButton);

                        removeButton.addEventListener('click', function () {
                            thumbnailPreview.src = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSzSncjhoWGdsxRm0LnCc5FD9kj86QoiTVAhw&s';
                            thumbnailPreview.classList.remove('show'); // ✅ đúng class
                            thumbnailInput.value = '';
                            this.remove();

                            const oldRemove = document.querySelector('input[name="remove_thumbnail"]');
                            if (!oldRemove) {
                                const hiddenInput = document.createElement('input');
                                hiddenInput.type = 'hidden';
                                hiddenInput.name = 'remove_thumbnail';
                                hiddenInput.value = 'true';
                                document.getElementById('productForm').appendChild(hiddenInput);
                            }
                        });
                    }
                }
            });


            // Nếu đã có nút xóa ảnh
            const removeButton = document.getElementById('remove-thumbnail');
            if (removeButton) {
                removeButton.addEventListener('click', function () {
                    const thumbnailPreview = document.getElementById('thumbnail-preview');
                    const thumbnailInput = document.getElementById('product_thumbnail');

                    // Sử dụng ảnh placeholder từ service bên ngoài thay vì đường dẫn local
                    thumbnailPreview.src = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSzSncjhoWGdsxRm0LnCc5FD9kj86QoiTVAhw&s';
                    thumbnailPreview.classList.add('hidden')
                    thumbnailInput.value = '';
                    document.getElementById('productForm').insertAdjacentHTML('beforeend', '<input type="hidden" name="remove_thumbnail" value="true">');
                });
            }

            // Add Attribute
            document.getElementById('add-attribute').addEventListener('click', function () {
                const container = document.getElementById('attributes-container');
                const newRow = document.createElement('div');
                newRow.className = 'attribute-row';
                newRow.innerHTML = `
                    <div class="row">
                        <div class="col-md-5">
                            <div class="mb-2">
                                <label class="form-label">Tên thuộc tính</label>
                                <input type="text" class="form-control" name="attribute_keys[]" placeholder="VD: Màu sắc, Kích thước...">
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="mb-2">
                                <label class="form-label">Giá trị</label>
                                <input type="text" class="form-control" name="attribute_values[]" placeholder="VD: Đỏ, XL...">
                            </div>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-sm remove-attribute">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(newRow);

                // Add event listener to the new remove button
                const removeButtons = newRow.querySelectorAll('.remove-attribute');
                removeButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        this.closest('.attribute-row').remove();
                    });
                });
            });

            // Initial remove attribute buttons
            document.querySelectorAll('.remove-attribute').forEach(button => {
                button.addEventListener('click', function () {
                    this.closest('.attribute-row').remove();
                });
            });


            document.getElementById('category').addEventListener('change', async function () {
                const categoryId = this.value;

                if (!categoryId) return;

                try {
                    const res = await fetch(`/v1/api/shop/categories/${categoryId}/attributes`);
                    const data = await res.json();

                    if (data && Array.isArray(data.attributes)) {
                        const container = document.getElementById('attributes-container');
                        container.innerHTML = ''; // Xóa các dòng hiện tại

                        data.attributes.forEach(attr => {
                            const row = document.createElement('div');
                            row.className = 'attribute-row';
                            row.innerHTML = `
                    <div class="row">
                        <div class="col-md-5">
                            <div class="mb-2">
                                <label class="form-label">Tên thuộc tính</label>
                                <input type="text" class="form-control" name="attribute_keys[]" value="${attr}" readonly>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="mb-2">
                                <label class="form-label">Giá trị</label>
                                <input type="text" class="form-control" name="attribute_values[]" placeholder="Nhập giá trị cho ${attr}">
                            </div>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-sm remove-attribute">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                            container.appendChild(row);
                        });
                    }
                } catch (err) {
                    console.error("Lỗi khi lấy thuộc tính:", err);
                }
            });

            // Add Variation
            document.getElementById('add-variation').addEventListener('click', function () {
                const container = document.getElementById('variations-container');
                const newRow = document.createElement('div');
                newRow.className = 'variation-row';
                newRow.innerHTML = `
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-2">
                                <label class="form-label">Tên biến thể</label>
                                <input type="text" class="form-control" name="variant_names[]" placeholder="VD: Màu, Size...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-2">
                                <label class="form-label">Giá trị</label>
                                <input type="text" class="form-control" name="variant_values[]" placeholder="VD: Đỏ, M...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-2">
                                <label class="form-label">Giá (VNĐ)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="variant_prices[]" placeholder="Giá biến thể">
                                    <span class="input-group-text">₫</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-2">
                                <label class="form-label">Kho</label>
                                <input type="number" class="form-control" name="variant_stocks[]" placeholder="Số lượng">
                            </div>
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-sm remove-variation">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(newRow);

                // Add event listener to the new remove button
                const removeButtons = newRow.querySelectorAll('.remove-variation');
                removeButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        this.closest('.variation-row').remove();
                    });
                });
            });

            // Initial remove variation buttons
            document.querySelectorAll('.remove-variation').forEach(button => {
                button.addEventListener('click', function () {
                    this.closest('.variation-row').remove();
                });
            });
        });
    </script>
</body>

</html>